<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ML-Driven QoS Network Controller</title>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/Leaflet/Leaflet.heat@gh-pages/dist/leaflet-heat.js"></script>
  <style>
    :root {
      --bg: #030c12;
      --panel: #061825;
      --border: #0a4060;
      --accent: #00d4ff;
      --green: #00ff88;
      --yellow: #ffb700;
      --red: #ff3355;
      --text: #c8e8f5;
      --dim: #3a6a80;
      --glow: 0 0 12px rgba(0, 212, 255, 0.4);
      --glow-g: 0 0 12px rgba(0, 255, 136, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    header {
      position: relative;
      z-index: 10;
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(0, 50, 80, 0.5) 0%, transparent 100%);
    }

    .logo {
      font-family: 'Orbitron', monospace;
      font-size: 1.3rem;
      font-weight: 900;
      color: var(--accent);
      text-shadow: var(--glow);
      letter-spacing: 2px;
    }

    .logo span {
      color: var(--green);
    }

    .status-bar {
      display: flex;
      gap: 24px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.75rem;
      color: var(--dim);
    }

    .status-bar .live {
      color: var(--green);
      animation: blink 1.5s infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.3
      }
    }

    .nav {
      display: flex;
      gap: 8px;
    }

    .nav-btn {
      padding: 6px 16px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--dim);
      font-family: 'Rajdhani', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 1px;
      text-transform: uppercase;
      transition: all 0.2s;
    }

    .nav-btn:hover,
    .nav-btn.active {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: var(--glow);
      background: rgba(0, 212, 255, 0.05);
    }

    .view-section {
      display: none;
      position: relative;
      z-index: 5;
      padding: 30px 40px;
      gap: 20px;
      animation: fadeIn 0.3s ease;
    }

    .view-section.active-view {
      display: block !important;
    }

    #map-container {
      height: 100%;
      width: 100%;
      background: #01080d;
      border: 1px solid var(--border);
      position: relative;
      z-index: 1;
    }

    .map-overlay {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 1000;
      display: flex;
      gap: 10px;
      background: rgba(3, 12, 18, 0.85);
      padding: 10px;
      border: 1px solid var(--accent);
      border-radius: 4px;
      backdrop-filter: blur(5px);
    }

    .map-input {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border);
      color: #fff;
      padding: 5px 10px;
      font-family: 'Share Tech Mono', monospace;
      outline: none;
      width: 200px;
    }

    .map-input:focus {
      border-color: var(--accent);
    }

    .map-btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 5px 12px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-weight: bold;
      transition: 0.2s;
    }

    .map-btn:hover {
      filter: brightness(1.2);
    }

    .hub-pulse {
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--accent);
      animation: hubPulse 2s infinite;
    }

    @keyframes hubPulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }

      100% {
        transform: scale(2.5);
        opacity: 0;
      }
    }

    .user-tooltip {
      background: rgba(255, 68, 68, 0.9);
      border: 1px solid #fff;
      color: #fff;
      font-family: 'Share Tech Mono', monospace;
      font-weight: bold;
      font-size: 0.7rem;
      box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
      border-radius: 0;
    }

    .user-tooltip::before {
      border-top-color: rgba(255, 68, 68, 0.9);
    }

    /* Cell Tower Markers */
    .tower-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      box-shadow: 0 0 10px currentColor;
      transition: transform 0.2s;
    }

    .tower-icon:hover {
      transform: scale(1.3);
    }

    /* Map Legend */
    .map-legend {
      position: absolute;
      bottom: 20px;
      right: 10px;
      z-index: 1000;
      background: rgba(3, 12, 18, 0.88);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 10px 14px;
      font-family: 'Rajdhani', sans-serif;
      font-size: 0.78rem;
      color: #ccc;
      min-width: 140px;
    }

    .map-legend h4 {
      color: var(--accent);
      margin: 0 0 8px 0;
      font-size: 0.8rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .hub-icon-container {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    #view-dashboard {
      grid-template-columns: 280px 1fr 280px;
      grid-template-rows: auto auto auto;
    }

    #view-analytics,
    #view-config,
    #view-logs {
      grid-template-columns: 1fr;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0.6;
    }

    .panel-title {
      font-family: 'Orbitron', monospace;
      font-size: 0.65rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, var(--border), transparent);
    }

    /* Traffic Sources Panel */
    .traffic-sources {
      grid-column: 1;
      grid-row: 1;
    }

    .traffic-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(10, 64, 96, 0.5);
    }

    .traffic-item:last-child {
      border: none;
    }

    .t-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .t-icon {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: var(--accent);
    }

    .t-bar-wrap {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .t-val {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.8rem;
      color: var(--accent);
    }

    .t-bar {
      width: 80px;
      height: 4px;
      background: rgba(10, 64, 96, 0.8);
    }

    .t-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--green));
      transition: width 1s;
    }

    /* Center - Main Flow */
    .main-flow {
      grid-column: 2;
      grid-row: 1 / 4;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Monitoring Panel */
    .monitoring-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px;
      position: relative;
    }

    .monitoring-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0.6;
    }

    .metrics-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 4px;
    }

    .metric-box {
      border: 1px solid var(--border);
      padding: 12px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .metric-val {
      font-family: 'Orbitron', monospace;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--green);
      text-shadow: var(--glow-g);
      display: block;
    }

    .metric-label {
      font-size: 0.7rem;
      color: var(--dim);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-top: 4px;
    }

    .metric-unit {
      font-size: 0.75rem;
      color: var(--dim);
    }

    /* ML Predictor */
    .ml-panel {
      background: linear-gradient(135deg, #041520, #061c10);
      border: 1px solid #0a5030;
      padding: 20px;
      position: relative;
    }

    .ml-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--green), transparent);
    }

    .congestion-states {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .state {
      flex: 1;
      padding: 12px 8px;
      text-align: center;
      border: 1px solid transparent;
      font-weight: 700;
      font-size: 0.85rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .state-low {
      border-color: rgba(0, 255, 136, 0.3);
      color: var(--green);
      background: rgba(0, 255, 136, 0.05);
    }

    .state-med {
      border-color: rgba(255, 183, 0, 0.3);
      color: var(--yellow);
      background: rgba(255, 183, 0, 0.05);
    }

    .state-high {
      border-color: rgba(255, 51, 85, 0.3);
      color: var(--red);
      background: rgba(255, 51, 85, 0.05);
    }

    .state.active-state {
      border-width: 2px;
    }

    .state-low.active-state {
      background: rgba(0, 255, 136, 0.15);
      box-shadow: 0 0 16px rgba(0, 255, 136, 0.3);
    }

    .state-med.active-state {
      background: rgba(255, 183, 0, 0.15);
      box-shadow: 0 0 16px rgba(255, 183, 0, 0.3);
    }

    .state-high.active-state {
      background: rgba(255, 51, 85, 0.15);
      box-shadow: 0 0 16px rgba(255, 51, 85, 0.3);
    }

    .state-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin: 0 auto 6px;
    }

    .state-low .state-indicator {
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
    }

    .state-med .state-indicator {
      background: var(--yellow);
      box-shadow: 0 0 8px var(--yellow);
    }

    .state-high .state-indicator {
      background: var(--red);
      box-shadow: 0 0 8px var(--red);
    }

    /* QoS Controller */
    .qos-panel {
      background: linear-gradient(135deg, #041520, #071025);
      border: 1px solid #082040;
      padding: 20px;
      position: relative;
    }

    .qos-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #6060ff, transparent);
    }

    .qos-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .qos-sub {
      border: 1px solid var(--border);
      padding: 12px;
    }

    .qos-sub-title {
      font-size: 0.7rem;
      color: var(--dim);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .queue-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.8rem;
    }

    .q-num {
      font-family: 'Share Tech Mono', monospace;
      color: var(--accent);
      width: 16px;
    }

    .q-bar-bg {
      flex: 1;
      height: 6px;
      background: rgba(10, 64, 96, 0.5);
    }

    .q-bar {
      height: 100%;
      background: linear-gradient(90deg, #4080ff, var(--accent));
    }

    .bw-item {
      margin-bottom: 8px;
    }

    .bw-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--dim);
      margin-bottom: 4px;
    }

    .bw-val {
      color: var(--accent);
      font-family: 'Share Tech Mono', monospace;
    }

    .bw-bar-bg {
      height: 6px;
      background: rgba(10, 64, 96, 0.5);
    }

    .bw-fill {
      height: 100%;
      background: linear-gradient(90deg, #4080ff, var(--green));
    }

    /* Performance Panel */
    .perf-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px;
      position: relative;
    }

    .perf-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--yellow), transparent);
    }

    .perf-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .perf-box {
      border: 1px solid var(--border);
      padding: 12px;
      text-align: center;
    }

    .perf-icon {
      font-size: 1.4rem;
      margin-bottom: 6px;
    }

    .perf-val {
      font-family: 'Orbitron', monospace;
      font-size: 1.2rem;
      font-weight: 700;
      display: block;
      margin-bottom: 4px;
    }

    .perf-label {
      font-size: 0.7rem;
      color: var(--dim);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Mini chart canvas */
    canvas.sparkline {
      width: 100%;
      height: 60px;
      display: block;
      margin-top: 10px;
    }

    /* Right panels */
    .right-col {
      grid-column: 3;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .feature-panel {
      grid-column: 1;
      grid-row: 2 / 4;
    }

    .alert-feed {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px;
      flex: 1;
    }

    .alert-feed::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--red), transparent);
    }

    .alert-feed {
      position: relative;
      overflow: hidden;
    }

    .alert-list {
      max-height: 200px;
      overflow: hidden;
    }

    .alert-item {
      display: flex;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(10, 64, 96, 0.3);
      font-size: 0.75rem;
      font-family: 'Share Tech Mono', monospace;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }

      to {
        opacity: 1;
        transform: none;
      }
    }

    .alert-time {
      color: var(--dim);
      white-space: nowrap;
    }

    .alert-msg {
      color: var(--text);
    }

    .alert-msg.warn {
      color: var(--yellow);
    }

    .alert-msg.crit {
      color: var(--red);
    }

    .alert-msg.ok {
      color: var(--green);
    }

    /* Bottleneck router */
    .router-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px;
      position: relative;
    }

    .router-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }

    .router-viz {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .router-node {
      width: 50px;
      height: 50px;
      border: 2px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      position: relative;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 8px rgba(0, 212, 255, 0.3)
      }

      50% {
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.7)
      }
    }

    .link-line {
      height: 2px;
      width: 20px;
      background: linear-gradient(90deg, var(--accent), var(--green));
      position: relative;
      overflow: hidden;
    }

    .link-line::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, white, transparent);
      animation: flow 1.5s linear infinite;
    }

    @keyframes flow {
      to {
        left: 100%;
      }
    }

    .utilization-wrap {
      margin-top: 14px;
    }

    .util-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-bottom: 6px;
    }

    .util-label {
      color: var(--dim);
    }

    .util-val {
      font-family: 'Share Tech Mono', monospace;
      color: var(--accent);
    }

    .util-bar-bg {
      height: 8px;
      background: rgba(10, 64, 96, 0.5);
      margin-bottom: 10px;
    }

    .util-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--green));
      position: relative;
      transition: width 1.5s;
    }

    /* Connector arrows */
    .connector {
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--accent);
      font-size: 1.2rem;
      opacity: 0.6;
      padding: 4px 0;
    }

    /* Feedback arrow indicator */
    .feedback-badge {
      position: absolute;
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.65rem;
      color: var(--dim);
      writing-mode: vertical-rl;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* Chart section */
    .chart-section {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px;
      position: relative;
      grid-column: 1 / 4;
    }

    .chart-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--green), transparent);
    }

    .chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-top: 4px;
    }

    .chart-box {
      position: relative;
    }

    .chart-box-title {
      font-size: 0.7rem;
      color: var(--dim);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    canvas.linechart {
      width: 100%;
      height: 80px;
    }

    footer {
      position: relative;
      z-index: 5;
      padding: 16px 40px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.7rem;
      color: var(--dim);
    }

    /* Responsive */
    @media(max-width:1100px) {
      #view-dashboard {
        grid-template-columns: 1fr 1fr;
      }

      .main-flow {
        grid-column: 1 / 3;
      }

      .right-col {
        grid-column: 1 / 3;
        flex-direction: row;
      }

      .feature-panel {
        display: none;
      }
    }

    /* Feature list */
    .feature-list {
      margin-top: 4px;
    }

    .feat-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(10, 64, 96, 0.3);
      font-size: 0.85rem;
    }

    .feat-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      flex-shrink: 0;
      box-shadow: 0 0 6px var(--accent);
    }

    .feat-val {
      margin-left: auto;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.75rem;
      color: var(--accent);
    }

    .feat-tag {
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 0.75rem;
      color: var(--dim);
      font-family: 'Share Tech Mono', monospace;
      transition: all 0.3s;
    }

    .feat-tag.active-feat {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(0, 212, 255, 0.1);
      box-shadow: 0 0 5px var(--accent);
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">DCN<span>PROJECT</span></div>
    <div class="status-bar">
      <span>SYS: <span class="live">‚óè ONLINE</span></span>
      <span>NODES: 24</span>
      <span>UPTIME: 99.97%</span>
      <span id="clock">00:00:00</span>
    </div>
    <div class="nav">
      <button class="nav-btn active" data-target="view-dashboard">DASHBOARD</button>
      <button class="nav-btn" data-target="view-analytics">ANALYTICS</button>
      <button class="nav-btn" data-target="view-map">MAP</button>
      <button class="nav-btn" data-target="view-dataset">DATASET</button>
      <button class="nav-btn" data-target="view-config">CONFIG</button>
      <button class="nav-btn" data-target="view-logs">LOGS</button>
    </div>
  </header>

  <main id="view-dashboard" class="view-section active-view">
    <!-- Left: Traffic Sources -->
    <div class="panel traffic-sources">
      <div class="panel-title">Traffic Sources</div>
      <div class="traffic-item">
        <div class="t-label">
          <div class="t-icon">üìû</div>
          VoIP
        </div>
        <div class="t-bar-wrap">
          <span class="t-val" id="t-voip-val">142 Kbps</span>
          <div class="t-bar">
            <div class="t-fill" id="t-voip-bar" style="width:35%"></div>
          </div>
        </div>
      </div>
      <div class="traffic-item">
        <div class="t-label">
          <div class="t-icon">üåê</div>
          HTTP
        </div>
        <div class="t-bar-wrap">
          <span class="t-val" id="t-http-val">4.7 Mbps</span>
          <div class="t-bar">
            <div class="t-fill" id="t-http-bar" style="width:72%"></div>
          </div>
        </div>
      </div>
      <div class="traffic-item">
        <div class="t-label">
          <div class="t-icon">üìÅ</div>
          FTP
        </div>
        <div class="t-bar-wrap">
          <span class="t-val" id="t-ftp-val">2.1 Mbps</span>
          <div class="t-bar">
            <div class="t-fill" id="t-ftp-bar" style="width:52%"></div>
          </div>
        </div>
      </div>
      <div style="margin-top:16px;">
        <div style="font-size:0.7rem;color:var(--dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">
          Aggregate Load</div>
        <canvas id="trafficChart" class="sparkline"></canvas>
      </div>
    </div>

    <!-- Center: Main Pipeline -->
    <div class="main-flow">
      <!-- Traffic Monitoring -->
      <div class="monitoring-panel">
        <div class="panel-title">‚¨¢ Traffic Monitoring</div>
        <div class="metrics-row">
          <div class="metric-box">
            <span class="metric-val" id="arrival-rate">847</span>
            <span class="metric-unit">pkt/s</span>
            <div class="metric-label">Arrival Rate</div>
          </div>
          <div class="metric-box">
            <span class="metric-val" id="delay-val">12.4</span>
            <span class="metric-unit">ms</span>
            <div class="metric-label">Delay</div>
          </div>
          <div class="metric-box">
            <span class="metric-val" id="queue-val">234</span>
            <span class="metric-unit">pkts</span>
            <div class="metric-label">Queue Length</div>
          </div>
        </div>
      </div>

      <div class="connector">‚ñº</div>

      <!-- Feature Extraction -->
      <div class="panel" style="padding:14px 20px;">
        <div class="panel-title" style="display:flex; justify-content:space-between;">
          <span>‚¨° Feature Extraction</span>
          <span
            style="color:var(--green); font-size:0.7rem; border:1px solid var(--green); padding:2px 6px; border-radius:3px;">SYSTEM
            ENABLED</span>
        </div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <span class="feat-tag" id="feat-jitter">jitter</span>
          <span class="feat-tag" id="feat-tput">throughput</span>
          <span class="feat-tag" id="feat-loss">loss_rate</span>
          <span class="feat-tag" id="feat-rtt">rtt</span>
          <span class="feat-tag" id="feat-burst">burstiness</span>
        </div>

        <div
          style="margin-top:15px; padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); font-family:'Share Tech Mono',monospace; font-size:0.8rem;">
          <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span style="color:var(--dim);">Identified Flow:</span>
            <span id="extraction-app" style="color:var(--accent);">ANALYZING...</span>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <span style="color:var(--dim);">Raw Feature Vector:</span>
            <span id="feature-vector" style="color:var(--green);">[0.0, 0.0, 0.0, 0.0, 0.0]</span>
          </div>
        </div>

        <div
          style="margin-top: 10px; background: rgba(0, 212, 255, 0.1); height: 2px; position: relative; overflow: hidden;">
          <div id="feature-progress"
            style="position: absolute; height: 100%; width: 30%; background: var(--accent); left: -100%; transition: left 1.5s linear;">
          </div>
        </div>
        <div
          style="margin-top:5px; text-align:right; font-size:0.65rem; color:var(--dim); font-family:'Share Tech Mono',monospace;">
          STREAMS PIPELINE: <span id="extraction-status">COLLECTING</span>
        </div>
      </div>

      <div class="connector">‚ñº</div>

      <!-- ML Predictor -->
      <div class="ml-panel">
        <div class="panel-title" style="color:var(--green);">‚óà using ml for traffic network</div>
        <div style="font-size:0.75rem;color:var(--dim);margin-bottom:10px;font-family:'Share Tech Mono',monospace;">
          Model: Random Forest ¬∑ Accuracy: <span style="color:var(--green);">96.8%</span> ¬∑ Last inference: <span
            id="infer-time">12ms</span>
        </div>
        <div class="congestion-states">
          <div class="state state-low active-state" id="state-low">
            <div class="state-indicator"></div>
            Low
          </div>
          <div class="state state-med" id="state-med">
            <div class="state-indicator"></div>
            Medium
          </div>
          <div class="state state-high" id="state-high">
            <div class="state-indicator"></div>
            High
          </div>
        </div>
        <div style="margin-top:12px;font-size:0.75rem;color:var(--dim);font-family:'Share Tech Mono',monospace;">
          Confidence: <span style="color:var(--green);" id="confidence">94.2%</span> &nbsp;|&nbsp; Prediction horizon:
          5s
        </div>
      </div>

      <div class="connector">‚ñº</div>

      <!-- Adaptive QoS Controller -->
      <div class="qos-panel">
        <div class="panel-title" style="color:#8888ff;">‚¨° Adaptive QoS Controller</div>
        <div class="qos-grid">
          <div class="qos-sub">
            <div class="qos-sub-title">Priority Queuing</div>
            <div class="queue-row">
              <span class="q-num">1</span>
              <div class="q-bar-bg">
                <div class="q-bar" id="q1" style="width:85%"></div>
              </div>
              <span style="font-size:0.7rem;color:var(--dim);font-family:'Share Tech Mono',monospace;">Priority</span>
            </div>
            <div class="queue-row">
              <span class="q-num">2</span>
              <div class="q-bar-bg">
                <div class="q-bar" id="q2" style="width:60%"></div>
              </div>
              <span style="font-size:0.7rem;color:var(--dim);font-family:'Share Tech Mono',monospace;">Standard</span>
            </div>
            <div class="queue-row">
              <span class="q-num">3</span>
              <div class="q-bar-bg">
                <div class="q-bar" id="q3" style="width:40%"></div>
              </div>
              <span style="font-size:0.7rem;color:var(--dim);font-family:'Share Tech Mono',monospace;">Bulk</span>
            </div>
          </div>
          <div class="qos-sub">
            <div class="qos-sub-title">Bandwidth Allocation</div>
            <div class="bw-item">
              <div class="bw-label"><span>Active Priority Flows</span><span class="bw-val" id="bw1">50%</span>
              </div>
              <div class="bw-bar-bg">
                <div class="bw-fill" id="bwf1" style="width:25%; background: var(--green);"></div>
              </div>
            </div>
            <div class="bw-item">
              <div class="bw-label"><span>Standard Data</span><span class="bw-val" id="bw2">35%</span></div>
              <div class="bw-bar-bg">
                <div class="bw-fill" id="bwf2" style="width:45%; background: var(--accent);"></div>
              </div>
            </div>
            <div class="bw-item">
              <div class="bw-label"><span>Bulk / Background Transfers</span><span class="bw-val" id="bw3">15%</span>
              </div>
              <div class="bw-bar-bg">
                <div class="bw-fill" id="bwf3" style="width:30%; background: var(--yellow);"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="connector">‚ñº</div>

      <!-- Bottleneck Router -->
      <div class="router-panel">
        <div class="panel-title">‚óà Bottleneck Router / Link</div>
        <div class="router-viz">
          <div class="router-node">üñ•</div>
          <div class="link-line"></div>
          <div class="router-node" style="border-color:var(--yellow);animation-name:pulse-y;">‚¨°</div>
          <div class="link-line"></div>
          <div class="router-node">üñ•</div>
        </div>
        <div class="utilization-wrap">
          <div class="util-row"><span class="util-label">Link Utilization</span><span class="util-val"
              id="link-util">67%</span></div>
          <div class="util-bar-bg">
            <div class="util-fill" id="link-fill" style="width:67%"></div>
          </div>
          <div class="util-row"><span class="util-label">Queue Occupancy</span><span class="util-val"
              id="queue-occ">43%</span></div>
          <div class="util-bar-bg">
            <div class="util-fill" id="queue-fill"
              style="width:43%;background:linear-gradient(90deg,#8888ff,var(--accent));"></div>
          </div>
        </div>
      </div>

      <div class="connector">‚ñº</div>

      <!-- Performance Analyzer -->
      <div class="perf-panel">
        <div class="panel-title" style="color:var(--yellow);">‚óâ Performance Analyzer</div>
        <div class="perf-metrics">
          <div class="perf-box">
            <div class="perf-icon">‚è±</div>
            <span class="perf-val" id="perf-delay" style="color:var(--green);">12.4 ms</span>
            <div class="perf-label">Delay</div>
          </div>
          <div class="perf-box">
            <div class="perf-icon">üìà</div>
            <span class="perf-val" id="perf-tput" style="color:var(--accent);">4.7 Gbps</span>
            <div class="perf-label">Throughput</div>
          </div>
          <div class="perf-box">
            <div class="perf-icon">üì¶</div>
            <span class="perf-val" id="perf-loss" style="color:var(--yellow);">0.12%</span>
            <div class="perf-label">Packet Loss</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="right-col">
      <!-- Alert Feed -->
      <div class="alert-feed panel">
        <div class="panel-title" style="color:var(--red);">‚¨° Event Log</div>
        <div class="alert-list" id="alert-list">
          <!-- Live alerts from system -->
        </div>
      </div>

      <!-- Model Stats -->
      <div class="panel">
        <div class="panel-title" style="color:var(--green);">Model Stats</div>
        <div style="font-size:0.75rem;font-family:'Share Tech Mono',monospace;">
          <div
            style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);color:var(--dim);">
            <span>Algorithm</span><span style="color:var(--accent);">Random Forest</span>
          </div>
          <div
            style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);color:var(--dim);">
            <span>Accuracy</span><span style="color:var(--green);">96.8%</span>
          </div>
          <div
            style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);color:var(--dim);">
            <span>Precision</span><span style="color:var(--green);">95.3%</span>
          </div>
          <div
            style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);color:var(--dim);">
            <span>Recall</span><span style="color:var(--green);">97.1%</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:6px 0;color:var(--dim);">
            <span>F1 Score</span><span style="color:var(--green);">0.962</span>
          </div>
        </div>
      </div>

      <!-- Feedback note -->
      <div class="panel" style="border-color:rgba(0,212,255,0.2);">
        <div class="panel-title">Feedback Loop</div>
        <div style="font-size:0.8rem;color:var(--dim);line-height:1.6;">
          Performance metrics feed back into <span style="color:var(--accent);">Traffic Monitoring</span> to
          continuously retrain and adapt the <span style="color:var(--green);">ML for Traffic Network</span> in
          real-time.
        </div>
        <div
          style="margin-top:12px;display:flex;align-items:center;gap:8px;font-size:0.7rem;font-family:'Share Tech Mono',monospace;color:var(--dim);">
          <span style="color:var(--green);">‚óè</span> Feedback active &nbsp; <span style="color:var(--accent);">‚Ü∫</span>
          Cycle: 5s
        </div>
      </div>
    </div>

    <!-- Bottom Charts -->
    <div class="chart-section" style="grid-row:3;grid-column:1/3">
      <div class="panel-title" style="color:var(--green);">‚óà Real-Time Performance Metrics</div>
      <div class="chart-row">
        <div class="chart-box">
          <div class="chart-box-title">Delay (ms)</div>
          <canvas id="delayChart" class="linechart"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-box-title">Throughput (Mbps)</div>
          <canvas id="tputChart" class="linechart"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-box-title">Packet Loss (%)</div>
          <canvas id="lossChart" class="linechart"></canvas>
        </div>
      </div>
    </div>

  </main>

  <main id="view-map" class="view-section">
    <div class="panel" style="height: calc(100vh - 180px); display: flex; flex-direction: column;">
      <div class="panel-title">
        <div class="t-icon">üåê</div> Global Network Traffic Map
      </div>
      <div
        style="flex: 1; margin: 15px 0; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; background: #000; position: relative;">
        <div class="map-overlay">
          <input type="text" id="map-search-input" class="map-input" placeholder="ENTER LOCATION AREA...">
          <button class="map-btn" onclick="searchLocation()">TARGET</button>
          <button class="map-btn" style="background: var(--green);" onclick="autoDetectLocation()">AUTO-SCAN</button>
        </div>
        <div id="map-container"></div>
        <div class="map-legend" id="map-legend" style="display:none;">
          <h4>üì° Networks</h4>
          <div class="legend-row">
            <div class="legend-dot" style="background:#00bfff;"></div> Jio (4G/5G)
          </div>
          <div class="legend-row">
            <div class="legend-dot" style="background:#ff6600;"></div> Airtel (4G/5G)
          </div>
          <div class="legend-row">
            <div class="legend-dot" style="background:#ff0080;"></div> Vi / Vodafone
          </div>
          <div class="legend-row">
            <div class="legend-dot" style="background:#00cc44;"></div> BSNL (3G/4G)
          </div>
          <div class="legend-row">
            <div class="legend-dot" style="background:#ffcc00;"></div> MTNL
          </div>
          <div style="margin-top:8px; color:#888; font-size:0.7rem;">üì∂ Click tower for details</div>
        </div>
      </div>
    </div>
  </main>
  <main id="view-dataset" class="view-section">
    <div class="panel" style="height: calc(100vh - 180px); overflow: hidden; display: flex; flex-direction: column;">
      <div class="panel-title" style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="t-icon" style="display:inline-block; border: none;">üìä</div> Network Metric Dataset (Excel View) |
          <span style="color:var(--yellow)">LOCAL TIME</span>
        </div>
        <div style="font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: var(--dim);">
          <span id="dataset-row-count">Loading...</span> | <span id="dataset-last-updated">--:--:--</span>
        </div>
      </div>
      <div
        style="flex: 1; overflow-y: auto; margin-top: 15px; border: 1px solid var(--border); background: rgba(0,0,0,0.3);">
        <table id="dataset-table" style="width: 100%; border-collapse: collapse; font-size: 0.8rem; text-align: left;">
          <thead style="position: sticky; top: 0; background: var(--bg); z-index: 10;">
            <tr>
              <th style="padding: 12px; border-bottom: 2px solid var(--accent); color: var(--accent);">TIMESTAMP</th>
              <th style="padding: 12px; border-bottom: 2px solid var(--accent); color: var(--accent);">PRIORITY FLOW (K)
              </th>
              <th style="padding: 12px; border-bottom: 2px solid var(--accent); color: var(--accent);">STANDARD FLOW (M)
              </th>
              <th style="padding: 12px; border-bottom: 2px solid var(--accent); color: var(--accent);">BULK FLOW (M)
              </th>
              <th style="padding: 12px; border-bottom: 2px solid var(--accent); color: var(--accent);">DELAY (MS)</th>
              <th style="padding: 12px; border-bottom: 2px solid var(--accent); color: var(--accent);">THROUGHPUT</th>
              <th style="padding: 12px; border-bottom: 2px solid var(--accent); color: var(--accent);">LOSS (%)</th>
              <th style="padding: 12px; border-bottom: 2px solid var(--accent); color: var(--accent);">STATE</th>
            </tr>
          </thead>
          <tbody id="dataset-body">
            <!-- Rows added via JS -->
          </tbody>
        </table>
      </div>
  </main>

  <main id="view-analytics" class="view-section">
    <div class="panel">
      <div class="panel-title">Analytics Engine</div>
      <div style="padding: 40px; text-align: center; color: var(--dim);">
        <h2>Advanced Network Analytics</h2>
        <p style="margin-top: 10px;">Historical data parsing and predictive model training interface.</p>
        <div style="margin-top: 50px; display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
          <div class="perf-box" style="width: 250px;">
            <div class="perf-icon">üß†</div>
            <span class="perf-val">Random Forest</span>
            <div class="perf-label">Active Classifier</div>
          </div>
          <div class="perf-box" style="width: 250px;">
            <div class="perf-icon" style="color:var(--green);">üéØ</div>
            <span class="perf-val" style="color:var(--green);" id="analytics-accuracy">96.8%</span>
            <div class="perf-label">Validation Accuracy</div>
          </div>
          <div class="perf-box" style="width: 250px;">
            <div class="perf-icon" style="color:var(--accent);">‚è±</div>
            <span class="perf-val" style="color:var(--accent);" id="analytics-infer">~11ms</span>
            <div class="perf-label">Average Inference Time</div>
          </div>
        </div>
        <div
          style="margin-top: 30px; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: 'Share Tech Mono', monospace; font-size: 0.9rem;">
          <div
            style="width: 10px; height: 10px; border-radius: 50%; background: var(--green); box-shadow: 0 0 10px var(--green); animation: pulse 1s infinite;">
          </div>
          <span id="analytics-status" style="color: var(--green);">ENGINE ACTIVE: CONTINUOUS LEARNING PIPELINE</span>
        </div>
        <div
          style="margin-top: 30px; text-align: center; font-size: 0.8rem; color: var(--dim); padding: 20px; border: 1px dashed var(--border);">
          <p>A simulated Machine Learning component analyzes load in real-time derived from Traffic Flow volume.</p>
          <p style="margin-top: 8px;">Because this is an active simulation loop, the metrics naturally build and release
            congestion states dynamically via the API.</p>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
      <div class="panel-title" style="color: var(--accent);">‚¨° Real-time Network Processes: Resource Monitor</div>
      <div style="padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">

        <!-- Active Processes (Live) -->
        <div id="process-list-container">
          <h3
            style="color: var(--green); margin-bottom: 20px; font-size: 1.1rem; display: flex; justify-content: space-between;">
            <span>üöÄ High Consumption Processes</span>
            <span style="font-family: 'Share Tech Mono', monospace; font-size: 0.85rem;" id="proc-sync-status">Status:
              LIVE DATA</span>
          </h3>

          <div id="active-processes-list">
            <!-- Dynamically populated from backend -->
            <div class="bw-item" style="margin-bottom: 16px;">
              <div class="bw-label"><span style="color: var(--text);" id="p-name-1">Process Monitor</span><span
                  class="bw-val" id="p-val-1">SCANNING...</span></div>
              <div class="bw-bar-bg" style="height: 10px; border-radius: 4px;">
                <div class="bw-fill" id="p-bar-1"
                  style="width:10%; background: linear-gradient(90deg, var(--green), #00ffaa); border-radius: 4px;">
                </div>
              </div>
            </div>
            <div class="bw-item" style="margin-bottom: 16px;">
              <div class="bw-label"><span style="color: var(--text);" id="p-name-2">System Kernel</span><span
                  class="bw-val" id="p-val-2">SCANNING...</span></div>
              <div class="bw-bar-bg" style="height: 10px; border-radius: 4px;">
                <div class="bw-fill" id="p-bar-2"
                  style="width:10%; background: linear-gradient(90deg, var(--green), #00ffaa); border-radius: 4px;">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Network Intelligence Info -->
        <div>
          <h3
            style="color: var(--yellow); margin-bottom: 20px; font-size: 1.1rem; display: flex; justify-content: space-between;">
            <span>üß† QoS Intelligence (ML Output)</span>
            <span style="font-family: 'Share Tech Mono', monospace; font-size: 0.85rem;"
              id="qos-intelligence-status">Status: ADAPTIVE</span>
          </h3>
          <div
            style="font-size: 0.85rem; color: var(--dim); line-height: 1.6; border: 1px dashed var(--border); padding: 15px;">
            <p>The Decision Tree model analyzes these real-time flows and OS telemetry to predict congestion.</p>
            <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div>
                <span style="color:var(--dim); font-size: 0.7rem; text-transform: uppercase;">Confidence</span><br>
                <span id="qos-intel-conf" style="color:var(--green); font-family: 'Share Tech Mono';">--%</span>
              </div>
              <div>
                <span style="color:var(--dim); font-size: 0.7rem; text-transform: uppercase;">Latency</span><br>
                <span id="qos-intel-time" style="color:var(--accent); font-family: 'Share Tech Mono';">--ms</span>
              </div>
            </div>
            <p
              style="margin-top: 10px; color:var(--text); border-top: 1px solid rgba(10,64,96,0.3); padding-top: 10px;">
              Current Policy:
              <span id="active-policy-desc" style="color:var(--accent);">Initializing...</span>
            </p>
          </div>
        </div>

      </div>

    </div>
    <div
      style="padding: 0 20px 20px 20px; font-size: 0.75rem; color: var(--dim); font-family: 'Share Tech Mono', monospace; display: flex; gap: 20px;">
      <span><strong style="color:var(--accent);">POLICY:</strong> RealTime-QoS-v1</span>
      <span><strong style="color:var(--accent);">NET ENGINE:</strong> Active (System Telemetry)</span>
      <span style="margin-left:auto;">System actively monitoring real-time network states to preserve Quality of Service
        for priority flows.</span>
    </div>
    </div>
  </main>

  <main id="view-config" class="view-section">
    <div class="panel">
      <div class="panel-title">QoS Policy Configuration</div>
      <div style="padding: 20px 40px; color: var(--text);">
        <h3 style="color: var(--accent); margin-bottom: 30px;">Traffic Shaping Rules</h3>
        <div style="display:flex; flex-direction:column; gap:25px; max-width: 500px;">
          <div
            style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(10,64,96,0.3); padding-bottom: 10px;">
            <div style="display: flex; flex-direction: column;">
              <label style="font-weight: 600;">System Priority Reservation</label>
              <span style="font-size: 0.7rem; color: var(--dim); margin-top: 4px;">Guaranteed bandwidth percentage for
                critical flows during High Congestion</span>
            </div>
            <input type="range" id="config-voip-alloc" min="10" max="80" value="50" style="width: 150px;">
          </div>
          <div
            style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(10,64,96,0.3); padding-bottom: 10px;">
            <div style="display: flex; flex-direction: column;">
              <label style="font-weight: 600;">Congestion Threshold Warning</label>
              <span style="font-size: 0.7rem; color: var(--dim); margin-top: 4px;">Trigger level for transitioning to
                Medium congestion</span>
            </div>
            <input type="range" id="config-threshold" min="0" max="1" step="0.05" value="0.4" style="width: 150px;">
          </div>
          <div
            style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(10,64,96,0.3); padding-bottom: 10px;">
            <div style="display: flex; flex-direction: column;">
              <label style="font-weight: 600;">Default FTP Priority Class</label>
              <span style="font-size: 0.7rem; color: var(--dim); margin-top: 4px;">How non-real-time file transfers are
                queued globally</span>
            </div>
            <select id="config-ftp-prio"
              style="background:var(--bg); color:var(--text); border:1px solid var(--accent); padding:6px 10px; width: 150px; font-family: 'Rajdhani', sans-serif;">
              <option value="low">Low (Scavenger)</option>
              <option value="std" selected>Standard (Best Effort)</option>
              <option value="high">High (Expedited)</option>
            </select>
          </div>

          <div style="margin-top: 20px; display: flex; gap: 15px;">
            <button class="nav-btn" style="flex: 1;" onclick="applyConfig()">Apply Policy</button>
            <button class="nav-btn" style="border-color: var(--dim); color: var(--dim);" onclick="resetConfig()">Reset
              Defaults</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <main id="view-logs" class="view-section">
    <div class="panel" style="height: 60vh; overflow-y: auto;">
      <div class="panel-title">System Event Logs</div>
      <div id="full-log-list" style="font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; line-height: 1.8;">
        <div class="alert-item" style="border-bottom: 1px solid rgba(10,64,96,0.3); padding: 8px 0;"><span
            class="alert-time" style="color:var(--dim); width: 80px; display:inline-block;">SYSTEM</span><span
            class="alert-msg">Logging engine initialized... awaiting network events from backend.</span></div>
      </div>
    </div>
  </main>

  <footer>
    <span>DCN PROJECT v2.4.1</span>
    <span>¬© 2026 DCN Project ‚Äî Adaptive Intelligence for Next-Gen Networks</span>
    <span id="footer-time">SYS TIME: --:--:--</span>
  </footer>

  <script>
    // Clock
    function updateClock() {
      const now = new Date();
      const t = now.toTimeString().slice(0, 8);
      document.getElementById('clock').textContent = t;
      document.getElementById('footer-time').textContent = 'SYS TIME: ' + t;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Chart utility
    function drawSparkline(canvas, data, color, fill) {
      const ctx = canvas.getContext('2d');
      const W = canvas.offsetWidth || 200;
      const H = canvas.offsetHeight || 60;
      canvas.width = W * devicePixelRatio;
      canvas.height = H * devicePixelRatio;
      ctx.scale(devicePixelRatio, devicePixelRatio);
      ctx.clearRect(0, 0, W, H);
      const min = Math.min(...data), max = Math.max(...data);
      const range = max - min || 1;
      const pts = data.map((v, i) => [i / (data.length - 1) * W, H - ((v - min) / range * (H - 10) + 5)]);
      if (fill) {
        ctx.beginPath();
        ctx.moveTo(pts[0][0], H);
        pts.forEach(p => ctx.lineTo(p[0], p[1]));
        ctx.lineTo(pts[pts.length - 1][0], H);
        ctx.closePath();
        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, color + '44');
        grad.addColorStop(1, color + '00');
        ctx.fillStyle = grad;
        ctx.fill();
      }
      ctx.beginPath();
      pts.forEach((p, i) => i === 0 ? ctx.moveTo(p[0], p[1]) : ctx.lineTo(p[0], p[1]));
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.stroke();
      // latest dot
      const last = pts[pts.length - 1];
      ctx.beginPath();
      ctx.arc(last[0], last[1], 3, 0, Math.PI * 2);
      ctx.fillStyle = color;
      ctx.fill();
    }

    // Data stores
    // Auto-detect backend: use Render on live site, localhost when developing
    const BACKEND_URL = (
      window.location.hostname === 'localhost' ||
      window.location.hostname === '127.0.0.1' ||
      window.location.hostname.startsWith('192.168.') ||
      window.location.hostname.startsWith('10.') ||
      window.location.hostname.startsWith('172.') ||
      window.location.protocol === 'file:'
    ) ? 'http://127.0.0.1:5002' : 'https://dcn-2.onrender.com';

    const N = 40;
    let delayData = Array.from({ length: N }, () => 10 + Math.random() * 8);
    let tputData = Array.from({ length: N }, () => 4 + Math.random() * 1.5);
    let lossData = Array.from({ length: N }, () => 0.05 + Math.random() * 0.15);
    let trafficData = Array.from({ length: N }, () => 50 + Math.random() * 30);

    // Standalone Mock Generator
    let phase = 0.0;
    let lastUpdate = Date.now() / 1000;

    // Virtual Config State
    let activeConfig = {
      voipAlloc: 50,
      threshold: 0.4,
      ftpPrio: "std"
    };

    // User alerts queue for mock state
    let pendingAlerts = [];
    let mockDataset = [];
    let lastMinuteSample = null;

    async function applyConfig() {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = "SYNCHRONIZING...";
      btn.disabled = true;

      activeConfig.voipAlloc = parseInt(document.getElementById('config-voip-alloc').value) || 50;
      activeConfig.threshold = parseFloat(document.getElementById('config-threshold').value) || 0.4;
      activeConfig.ftpPrio = document.getElementById('config-ftp-prio').value || "std";

      const now_str = new Date().toTimeString().slice(0, 8);
      console.log("Applying Config to:", BACKEND_URL, activeConfig);

      try {
        const res = await fetch(`${BACKEND_URL}/api/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            voip_alloc: activeConfig.voipAlloc,
            threshold: activeConfig.threshold,
            ftp_prio: activeConfig.ftpPrio
          })
        });
        if (res.ok) {
          pendingAlerts.push({ time: now_str, msg: "SYSTEM: QoS Policy successfully synchronized with DCN Controller", cls: "ok" });
        } else {
          throw new Error("Server returned " + res.status);
        }
      } catch (e) {
        console.error("Config Sync Error:", e);
        pendingAlerts.push({ time: now_str, msg: "ERROR: Controller Sync Failed. Operating in Local Override mode.", cls: "crit" });
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    function resetConfig() {
      document.getElementById('config-voip-alloc').value = 50;
      document.getElementById('config-threshold').value = 0.4;
      document.getElementById('config-ftp-prio').value = "std";
      applyConfig();
      const now_str = new Date().toTimeString().slice(0, 8);
      pendingAlerts.push({ time: now_str, msg: "USER: Reverted to Default Policies", cls: "warn" });
    }

    function getMockState() {
      // Logic removed - server is mandatory for real-time data
      return null;
    }

    // API Data Poll
    async function fetchState() {
      let data;
      try {
        const res = await fetch(`${BACKEND_URL}/api/status`);
        if (!res.ok) throw new Error("HTTP Request Failed");
        data = await res.json();
      } catch (e) {
        // Fallback to standalone mode if backend is not running
        data = getMockState();
      }

      if (!data) return; // Prevention for null data parsing

      try {
        // 1. Process alerts from backend + user actions (High Priority)
        let allAlerts = [...(data.alerts || []), ...pendingAlerts];
        pendingAlerts = []; // Clear queue after processing

        // Filter out unwanted chatter (DPI logs and Nominal status)
        allAlerts = allAlerts.filter(msg => {
          const m = (msg.msg || "").toLowerCase();
          return !m.includes("dpi engine") && !m.includes("nominal traffic");
        });

        if (allAlerts.length > 0) {
          const list = document.getElementById('alert-list');
          const fullList = document.getElementById('full-log-list');
          allAlerts.forEach(msg => {
            const item = document.createElement('div');
            item.className = 'alert-item';
            item.innerHTML = `<span class="alert-time" style="width:80px; display:inline-block; color:var(--dim);">${msg.time}</span><span class="alert-msg ${msg.cls || ''}">${msg.msg}</span>`;

            if (list) {
              list.insertBefore(item.cloneNode(true), list.firstChild);
              if (list.children.length > 8) list.removeChild(list.lastChild);
            }

            if (fullList) {
              const logItem = item.cloneNode(true);
              logItem.style.borderBottom = '1px solid rgba(10,64,96,0.3)';
              logItem.style.padding = '8px 0';
              fullList.insertBefore(logItem, fullList.firstChild);
              if (fullList.children.length > 200) fullList.removeChild(fullList.lastChild);
            }
          });
        }

        // 2. Update Charts Data
        delayData.push(data.performance.delay); delayData.shift();
        tputData.push(data.performance.throughput); tputData.shift();
        lossData.push(data.performance.packet_loss); lossData.shift();
        trafficData.push(data.traffic.aggregate); trafficData.shift();

        const delayChart = document.getElementById('delayChart');
        if (delayChart) drawSparkline(delayChart, delayData, '#00ff88', true);
        const tputChart = document.getElementById('tputChart');
        if (tputChart) drawSparkline(tputChart, tputData, '#00d4ff', true);
        const lossChart = document.getElementById('lossChart');
        if (lossChart) drawSparkline(lossChart, lossData, '#ffb700', true);
        const trafficChart = document.getElementById('trafficChart');
        if (trafficChart) drawSparkline(trafficChart, trafficData, '#00d4ff', true);

        // 3. Performance Values
        const elDelayVal = document.getElementById('delay-val');
        if (elDelayVal) elDelayVal.textContent = data.monitoring.delay.toFixed(1);
        const elPerfDelay = document.getElementById('perf-delay');
        if (elPerfDelay) elPerfDelay.textContent = data.performance.delay.toFixed(1) + ' ms';
        const elPerfTput = document.getElementById('perf-tput');
        if (elPerfTput) elPerfTput.textContent = data.performance.throughput.toFixed(2) + ' Gbps';
        const elPerfLoss = document.getElementById('perf-loss');
        if (elPerfLoss) elPerfLoss.textContent = data.performance.packet_loss.toFixed(2) + '%';

        // 4. Traffic Sources
        const elTVoipVal = document.getElementById('t-voip-val');
        if (elTVoipVal) elTVoipVal.textContent = data.traffic.voip + ' Kbps';
        const elTVoipBar = document.getElementById('t-voip-bar');
        if (elTVoipBar) elTVoipBar.style.width = Math.min(100, (data.traffic.voip / 200 * 100)) + '%';
        const elTHttpVal = document.getElementById('t-http-val');
        if (elTHttpVal) elTHttpVal.textContent = data.traffic.http.toFixed(1) + ' Mbps';
        const elTHttpBar = document.getElementById('t-http-bar');
        if (elTHttpBar) elTHttpBar.style.width = Math.min(100, (data.traffic.http / 12 * 100)) + '%';
        const elTFtpVal = document.getElementById('t-ftp-val');
        if (elTFtpVal) elTFtpVal.textContent = data.traffic.ftp.toFixed(1) + ' Mbps';
        const elTFtpBar = document.getElementById('t-ftp-bar');
        if (elTFtpBar) elTFtpBar.style.width = Math.min(100, (data.traffic.ftp / 5 * 100)) + '%';

        // 5. Monitoring
        const elArrivalRate = document.getElementById('arrival-rate');
        if (elArrivalRate) elArrivalRate.textContent = data.monitoring.arrival_rate;
        const elQueueVal = document.getElementById('queue-val');
        if (elQueueVal) elQueueVal.textContent = data.monitoring.queue_length;

        // 6. Feature Extraction Animation
        const statusEl = document.getElementById('extraction-status');
        const vectorEl = document.getElementById('feature-vector');
        const progressEl = document.getElementById('feature-progress');
        const appEl = document.getElementById('extraction-app');
        if (statusEl && vectorEl && progressEl && appEl) {
          statusEl.textContent = "EXTRACTING";
          statusEl.style.color = "var(--accent)";
          appEl.textContent = "ANALYZING SYSTEM FLOW...";
          appEl.style.color = "var(--dim)";

          progressEl.style.transition = "none";
          progressEl.style.left = "-100%";
          setTimeout(() => {
            progressEl.style.transition = "left 1.5s linear";
            progressEl.style.left = "100%";
          }, 50);

          setTimeout(() => {
            statusEl.textContent = "COMPLETE (L7)";
            statusEl.style.color = "var(--green)";
            const identified = (data.processes && data.processes.length > 0) ? data.processes[0] : "System Packet Flow";
            appEl.textContent = identified;
            appEl.style.color = 'var(--green)';

            const base = (data.traffic.aggregate / 100);
            const vec = Array.from({ length: 5 }, () => (base * (0.8 + Math.random() * 0.4)).toFixed(2));
            vectorEl.textContent = `[${vec.join(', ')}]`;
          }, 1600);
        }

        // 7. ML Predictor
        ['low', 'med', 'high'].forEach(s => {
          const el = document.getElementById('state-' + s);
          if (el) el.classList.toggle('active-state', s === data.ml.state);
        });
        const elConfidence = document.getElementById('confidence');
        if (elConfidence) elConfidence.textContent = data.ml.confidence + '%';
        const elInferTime = document.getElementById('infer-time');
        if (elInferTime) elInferTime.textContent = data.ml.infer_time + 'ms';

        // 8. Analytics Engine Animation
        const accuracySpan = document.getElementById('analytics-accuracy');
        const inferSpan = document.getElementById('analytics-infer');
        if (accuracySpan && inferSpan) {
          const rAcc = 96.0 + Math.random() * 1.5;
          accuracySpan.textContent = rAcc.toFixed(1) + '%';
          const rInf = Math.floor(8 + Math.random() * 6);
          inferSpan.textContent = '~' + rInf + 'ms';

          const sStatusEl = document.getElementById('analytics-status');
          if (sStatusEl) {
            if (Math.random() < 0.1) {
              sStatusEl.textContent = "ENGINE ACTIVE: RETRAINING MODEL...";
              sStatusEl.style.color = "var(--accent)";
            } else {
              sStatusEl.textContent = "ENGINE ACTIVE: CONTINUOUS LEARNING PIPELINE";
              sStatusEl.style.color = "var(--green)";
            }
          }
        }

        // 9. Real-time Processes Panel Update
        const procListBody = document.getElementById('active-processes-list');
        if (procListBody && data.processes) {
          procListBody.innerHTML = '';
          data.processes.slice(0, 5).forEach((proc, idx) => {
            const div = document.createElement('div');
            div.className = 'bw-item';
            div.style.marginBottom = '16px';
            const hash = proc.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);

            // Artificial weighting based on application type
            let weight = 0.5 + (hash % 40) / 20.0;
            if (proc.toLowerCase().includes('chrome') || proc.toLowerCase().includes('edge') || proc.toLowerCase().includes('cef')) weight *= 1.8;
            if (proc.toLowerCase().includes('python') || proc.toLowerCase().includes('dcn')) weight *= 0.6;

            const loadPerc = 5 + (weight * 15) + (hash % 10) * (data.traffic.aggregate / 20.0);
            const mbps = (loadPerc * 0.8).toFixed(1);
            div.innerHTML = `
              <div class="bw-label"><span style="color: var(--text);">${proc}</span><span class="bw-val">${mbps} Mbps</span></div>
              <div class="bw-bar-bg" style="height: 10px; border-radius: 4px;">
                <div class="bw-fill" style="width:${loadPerc}%; background: linear-gradient(90deg, var(--green), #00ffaa); border-radius: 4px; transition: width 0.5s;"></div>
              </div>
            `;
            procListBody.appendChild(div);
          });

          const elPolicyDesc = document.getElementById('active-policy-desc');
          if (elPolicyDesc) {
            elPolicyDesc.textContent = data.ml.state === 'high' ?
              "CRITICAL CONGESTION: Restricting background throughput to preserve low-latency channels." :
              "NOMINAL LOAD: Optimized for maximum system-wide link utilization.";
          }
        }

        // 10. Adaptive QoS Controllers
        const qos = data.qos;
        const q1 = document.getElementById('q1'); if (q1) q1.style.width = qos.queues.voip + '%';
        const q2 = document.getElementById('q2'); if (q2) q2.style.width = qos.queues.http + '%';
        const q3 = document.getElementById('q3'); if (q3) q3.style.width = qos.queues.ftp + '%';

        const bw1 = document.getElementById('bw1'); if (bw1) bw1.textContent = qos.bandwidth.voip + '%';
        const bwf1 = document.getElementById('bwf1'); if (bwf1) bwf1.style.width = qos.bandwidth.voip + '%';
        const bw2 = document.getElementById('bw2'); if (bw2) bw2.textContent = qos.bandwidth.http + '%';
        const bwf2 = document.getElementById('bwf2'); if (bwf2) bwf2.style.width = qos.bandwidth.http + '%';
        const bw3 = document.getElementById('bw3'); if (bw3) bw3.textContent = qos.bandwidth.ftp + '%';
        const bwf3 = document.getElementById('bwf3'); if (bwf3) bwf3.style.width = qos.bandwidth.ftp + '%';

        // 11. Router Utilization
        const elLinkUtil = document.getElementById('link-util');
        if (elLinkUtil) elLinkUtil.textContent = data.router.link_utilization + '%';
        const elLinkFill = document.getElementById('link-fill');
        if (elLinkFill) elLinkFill.style.width = data.router.link_utilization + '%';
        const elQueueOcc = document.getElementById('queue-occ');
        if (elQueueOcc) elQueueOcc.textContent = data.router.queue_occupancy + '%';
        const elQueueFill = document.getElementById('queue-fill');
        if (elQueueFill) elQueueFill.style.width = data.router.queue_occupancy + '%';

        // 12. Update secondary QoS panel
        const qIntConf = document.getElementById('qos-intel-conf');
        const qIntTime = document.getElementById('qos-intel-time');
        if (qIntConf) qIntConf.textContent = data.ml.confidence + '%';
        if (qIntTime) qIntTime.textContent = data.ml.infer_time + 'ms';

        // 13. Heartbeat indicator
        const hbStatus = document.getElementById('proc-sync-status');
        if (hbStatus) hbStatus.textContent = "Status: SYNC " + new Date().toTimeString().slice(0, 8);
      } catch (e) {
        console.warn("Error processing data:", e);
      }
    }

    async function fetchDataset() {
      const countEl = document.getElementById('dataset-row-count');
      const lastUpdEl = document.getElementById('dataset-last-updated');
      if (countEl) countEl.textContent = 'Fetching...';

      let data;
      try {
        const res = await fetch(`${BACKEND_URL}/api/dataset`);
        if (!res.ok) throw new Error("Dataset fetch failed: " + res.status);
        data = await res.json();
      } catch (e) {
        console.error('fetchDataset error:', e);
        if (countEl) countEl.textContent = '‚ö† Fetch failed';
        return;
      }

      if (!Array.isArray(data) || data.length === 0) {
        if (countEl) countEl.textContent = 'No data in DB yet';
        return;
      }

      const body = document.getElementById('dataset-body');
      if (!body) return;

      body.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid var(--border)';
        tr.style.backgroundColor = 'rgba(0,0,0,0.1)';

        // Base time string safely fallback
        let displayTime = row.time || '‚Äî';

        if (row.timestamp) {
          try {
            // Javascript parses the GMT timestamp and naturally aligns to the user's Local timezone (IST)
            const date = new Date(row.timestamp);
            if (!isNaN(date.getTime())) {
              displayTime = date.getHours().toString().padStart(2, '0') + ':' +
                date.getMinutes().toString().padStart(2, '0') + ':' +
                date.getSeconds().toString().padStart(2, '0');
            }
          } catch (e) {
            console.warn("Time parse error:", e);
          }
        }
        const stateColor = row.state === 'high' ? 'var(--red)' : (row.state === 'med' ? 'var(--accent)' : 'var(--green)');

        tr.innerHTML = `
          <td style="padding: 8px 10px; font-family: 'Share Tech Mono'; color: var(--dim);">${displayTime}</td>
          <td style="padding: 8px 10px; border-left: 1px solid var(--border);">${row.voip !== undefined ? row.voip : '‚Äî'}</td>
          <td style="padding: 8px 10px; border-left: 1px solid var(--border);">${row.http !== undefined ? row.http : '‚Äî'}</td>
          <td style="padding: 8px 10px; border-left: 1px solid var(--border);">${row.ftp !== undefined ? row.ftp : '‚Äî'}</td>
          <td style="padding: 8px 10px; border-left: 1px solid var(--border);">${row.delay !== undefined ? row.delay : '‚Äî'}</td>
          <td style="padding: 8px 10px; border-left: 1px solid var(--border);">${row.throughput !== undefined ? row.throughput : '‚Äî'}</td>
          <td style="padding: 8px 10px; border-left: 1px solid var(--border);">${row.loss !== undefined ? row.loss : '‚Äî'}</td>
          <td style="padding: 8px 10px; border-left: 1px solid var(--border); color: ${stateColor}; font-weight: bold;">${row.state ? row.state.toUpperCase() : '‚Äî'}</td>
        `;
        body.appendChild(tr);
      });

      if (countEl) countEl.textContent = `${data.length} rows`;
      if (lastUpdEl) lastUpdEl.textContent = new Date().toLocaleTimeString([], { hour12: false });
    }

    // Init polling
    window.addEventListener('load', () => {
      setInterval(fetchState, 2000);
      setInterval(fetchDataset, 4000);
      fetchState();
      fetchDataset();
    });

    // Nav tab interaction
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const targetId = this.getAttribute('data-target');
        if (!targetId) return; // Ignore buttons without targets

        // Update active tab Button
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // Update active View
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));
        const targetEl = document.getElementById(targetId);
        if (targetEl) targetEl.classList.add('active-view');

        // Special handling for map resize
        if (targetId === 'view-map') {
          if (!window.networkMap) {
            initNetworkMap();
          } else {
            setTimeout(() => {
              window.networkMap.invalidateSize();
            }, 200);
          }
        }
      });
    });

    // --- MAP LOGIC ---
    window.networkMap = null;
    const hubs = [
      { id: "mumbai", name: "Mumbai (Jio)", lat: 19.0760, lng: 72.8777, intensity: 1.2 },
      { id: "delhi", name: "Delhi (Airtel)", lat: 28.6139, lng: 77.2090, intensity: 1.5 },
      { id: "blr", name: "Bengaluru (Vi)", lat: 12.9716, lng: 77.5946, intensity: 1.0 },
      { id: "chennai", name: "Chennai (BSNL)", lat: 13.0827, lng: 80.2707, intensity: 0.8 },
      { id: "hyd", name: "Hyderabad (Jio)", lat: 17.3850, lng: 78.4867, intensity: 1.1 }
    ];

    function initNetworkMap() {
      if (window.networkMap) return;

      window.networkMap = L.map('map-container', {
        zoomControl: false,
        attributionControl: false,
        worldCopyJump: false,
        maxBoundsViscosity: 1.0,
        minZoom: 2,
        maxZoom: 18
      }).setView([22.0, 79.0], 5);

      // Restrict to single world copy
      const bounds = L.latLngBounds(L.latLng(-90, -180), L.latLng(90, 180));
      window.networkMap.setMaxBounds(bounds);

      // Satellite Hybrid Mode (lyrs=y)
      L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        noWrap: true,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
      }).addTo(window.networkMap);

      // Initialize Heatmap
      const heatPoints = hubs.map(h => [h.lat, h.lng, h.intensity]);
      window.heatLayer = L.heatLayer(heatPoints, {
        radius: 35,
        blur: 20,
        maxZoom: 10,
        gradient: { 0.4: 'cyan', 0.65: 'lime', 1: 'red' }
      }).addTo(window.networkMap);

      const hubIcon = L.divIcon({
        className: 'hub-icon-container',
        html: '<div class="hub-pulse" style="width:12px; height:12px;"></div>',
        iconSize: [16, 16]
      });

      hubs.forEach(h => {
        const popupContent = `
          <div style="text-align: center; font-family: 'Rajdhani', sans-serif;">
            <b style="color:var(--accent);font-size:1.1em;">${h.name}</b><br>
            Traffic Load: <span id="int-${h.id}">${h.intensity}</span><br>
            <button onclick="focusOnLocation(${h.lat}, ${h.lng}, '${h.name}')" style="margin-top:8px; padding:4px 8px; background:var(--accent); color:#fff; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">
              Scan Live Network
            </button>
          </div>
        `;
        L.marker([h.lat, h.lng], { icon: hubIcon })
          .addTo(window.networkMap)
          .bindPopup(popupContent);
      });

      // Dynamic Traffic lines
      window.trafficLines = [];
      function updateMapTraffic() {
        if (!window.networkMap || !window.heatLayer) return;

        const globalScale = window.lastMetrics ? (window.lastMetrics.traffic.aggregate / 5) : 1.0;
        let points = [];

        // Focus Heat on Active Target Hubs (Global or Local)
        hubs.forEach(h => {
          const scaledIntensity = h.intensity * globalScale * (0.8 + Math.random() * 0.4);
          const span = document.getElementById(`int-${h.id}`);
          if (span) span.innerText = scaledIntensity.toFixed(2);
          points.push([h.lat, h.lng, scaledIntensity]);
        });

        // Add heat for user's active marker
        if (window.userMarker) {
          const pos = window.userMarker.getLatLng();
          points.push([pos.lat, pos.lng, 2.0 * globalScale]);
        }

        window.heatLayer.setLatLngs(points);

        // Remove old lines
        window.trafficLines.forEach(l => window.networkMap.removeLayer(l));
        window.trafficLines = [];

        // Simplified lines for clarity
        if (window.userMarker && hubs.length > 0) {
          const upos = window.userMarker.getLatLng();
          const hpos = hubs[0];
          const line = L.polyline([
            [upos.lat, upos.lng],
            [hpos.lat, hpos.lng]
          ], {
            color: 'var(--accent)',
            weight: 2,
            opacity: 0.6,
            dashArray: '10, 20'
          }).addTo(window.networkMap);
          window.trafficLines.push(line);
        }
      }

      setInterval(updateMapTraffic, 3000);
      updateMapTraffic();
    }

    async function searchLocation() {
      if (window.location.protocol === 'file:') {
        alert("SECURITY ALERT: MAP TARGETING (CORS) IS BLOCKED WHEN OPENED AS A LOCAL FILE.\n\nPLEASE USE THE LOCAL SERVER URL INSTEAD:\nhttp://127.0.0.1:5002");
        return;
      }

      const q = document.getElementById('map-search-input').value;
      if (!q) return;

      const isLive = window.location.hostname.includes('github.io');

      // If live, prioritize ArcGIS to avoid Nominatim CORS blocks
      if (isLive) {
        try {
          const arcgisUrl = `https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(q)}&maxLocations=1`;
          const r = await fetch(arcgisUrl);
          const d = await r.json();
          if (d.candidates && d.candidates.length > 0) {
            const best = d.candidates[0];
            focusOnLocation(best.location.y, best.location.x, best.address);
            return;
          }
        } catch (e) { console.warn("ArcGIS failed, trying Nominatim legacy..."); }
      }

      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`);
        const data = await res.json();
        if (data && data.length > 0) {
          focusOnLocation(parseFloat(data[0].lat), parseFloat(data[0].lon), q.toUpperCase());
        } else {
          // One last attempt with ArcGIS if Nominatim had no results
          if (!isLive) throw new Error("No result");
          alert("LOCATION NOT FOUND.");
        }
      } catch (e) {
        console.warn("Geocoding fetch failed, trying fallback...");
        try {
          const r2 = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(q)}&maxLocations=1`);
          const d2 = await r2.json();
          if (d2.candidates && d2.candidates.length > 0) {
            const best = d2.candidates[0];
            focusOnLocation(best.location.y, best.location.x, best.address);
          } else { alert("LOCATION NOT FOUND."); }
        } catch (e2) {
          alert("GEOTARGETING ERROR: UNABLE TO CONNECT TO REMOTE DATABASE.");
        }
      }
    }

    function autoDetectLocation() {
      if (!navigator.geolocation) {
        alert("GEOLOCATION NOT SUPPORTED BY SYSTEM.");
        return;
      }

      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = "SCANNING...";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          focusOnLocation(pos.coords.latitude, pos.coords.longitude, "SCAN-DETECTED AREA");
          btn.textContent = originalText;
        },
        (err) => {
          alert("GEOLOCATION DENIED OR UNAVAILABLE.");
          btn.textContent = originalText;
        }
      );
    }

    window.userMarker = null;
    window.localHubs = [];

    function focusOnLocation(lat, lng, label) {
      if (!window.networkMap) return;

      window.networkMap.setView([lat, lng], 13);

      if (window.userMarker) window.networkMap.removeLayer(window.userMarker);

      const userIcon = L.divIcon({
        className: 'user-icon-container',
        html: '<div class="hub-pulse" style="background:var(--red); box-shadow: 0 0 15px var(--red);"></div>',
        iconSize: [30, 30]
      });

      window.userMarker = L.marker([lat, lng], { icon: userIcon })
        .addTo(window.networkMap)
        .bindPopup(`<b style="color:var(--red)">YOUR LOCATION</b><br>${label}`)
        .bindTooltip(label, { permanent: true, direction: 'top', className: 'user-tooltip' })
        .openPopup();

      // Clear old towers
      window.localHubs.forEach(h => window.networkMap.removeLayer(h));
      window.localHubs = [];

      // -- REAL cell tower data via Flask proxy ‚Üí OpenCelliD --
      const legend = document.getElementById('map-legend');
      if (legend) {
        legend.style.display = 'block';
        legend.innerHTML = '<h4>üì° Networks</h4><div style="color:#aaa;font-size:0.75rem;">‚è≥ Scanning live towers...</div>';
      }

      // MNC ‚Üí operator name + color for Indian networks
      const mncMap = {
        '404-26': { name: 'Jio', color: '#00bfff' },
        '405-826': { name: 'Jio', color: '#00bfff' },
        '405-854': { name: 'Jio', color: '#00bfff' },
        '405-855': { name: 'Jio', color: '#00bfff' },
        '405-869': { name: 'Jio', color: '#00bfff' },
        '405-874': { name: 'Jio', color: '#00bfff' },
        '404-10': { name: 'Airtel', color: '#ff6600' },
        '404-45': { name: 'Airtel', color: '#ff6600' },
        '404-49': { name: 'Airtel', color: '#ff6600' },
        '405-01': { name: 'Airtel', color: '#ff6600' },
        '404-20': { name: 'Vi', color: '#ff0080' },
        '404-43': { name: 'Vi', color: '#ff0080' },
        '404-60': { name: 'Vi', color: '#ff0080' },
        '405-02': { name: 'Vi', color: '#ff0080' },
        '404-16': { name: 'BSNL', color: '#00cc44' },
        '404-27': { name: 'BSNL', color: '#00cc44' },
        '404-53': { name: 'BSNL', color: '#00cc44' },
        '404-54': { name: 'BSNL', color: '#00cc44' },
        '404-68': { name: 'MTNL', color: '#ffcc00' },
        '404-69': { name: 'MTNL', color: '#ffcc00' },
      };
      const radioLabels = { 'LTE': '4G', 'NR': '5G', 'UMTS': '3G', 'GSM': '2G', 'CDMA': 'CDMA' };

      const overpassServers = [
        'https://overpass-api.de/api/interpreter',
        'https://overpass.kumi.systems/api/interpreter',
        'https://lz4.overpass-api.de/api/interpreter',
        'https://z.overpass-api.de/api/interpreter'
      ];
      let serverIdx = 0;

      const fetchTowers = (url, isProxy) => {
        return fetch(url, isProxy ? {} : {
          method: 'POST',
          body: 'data=' + encodeURIComponent(`[out:json][timeout:25];(node["man_made"="mast"]["communication:mobile_phone"="yes"](around:5000,${lat},${lng});node["man_made"="telecommunications_tower"](around:5000,${lat},${lng});node["tower:type"="communication"](around:5000,${lat},${lng});node["communication:mobile_phone"="yes"](around:5000,${lat},${lng}););out body;`)
        })
          .then(async r => {
            if (r.status === 429 && !isProxy && serverIdx < overpassServers.length - 1) {
              serverIdx++;
              console.log(`Rate limited. Retrying with server ${serverIdx}...`);
              return fetchTowers(overpassServers[serverIdx], false);
            }
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          })
          .then(data => {
            const cells = isProxy ? (data.cells || []) : (data.elements || []);
            const foundOps = new Map();

            cells.forEach(el => {
              let opRaw, color, radio, tLat, tLng, infoHtml;

              if (isProxy) {
                const mccMnc = `${el.mcc}-${el.mnc}`;
                const opInfo = mncMap[mccMnc] || { name: `MCC${el.mcc}/MNC${el.mnc}`, color: '#aaaaaa' };
                opRaw = opInfo.name;
                color = opInfo.color;
                radio = radioLabels[el.radio] || el.radio || 'Unknown';
                tLat = parseFloat(el.lat);
                tLng = parseFloat(el.lon);
                infoHtml = `<div><b>Radio:</b> <span style="color:${color}">${radio}</span></div>
                          <div><b>Cell ID:</b> ${el.cellid || '?'}</div>
                          <div><b>LAC:</b> ${el.lac || '?'}</div>
                          <div><b>MCC/MNC:</b> ${el.mcc}/${el.mnc}</div>`;
              } else {
                const tags = el.tags || {};
                opRaw = tags.operator || tags.network || tags.brand || 'Unknown';
                const opKey = opRaw.toLowerCase();
                const colorKey = Object.keys(mncMap).find(k => mncMap[k].name.toLowerCase() === opKey) ||
                  Object.keys(mncMap).find(k => opKey.includes(mncMap[k].name.toLowerCase()));
                color = colorKey ? mncMap[colorKey].color : '#aaaaaa';
                radio = tags['communication:LTE'] === 'yes' ? '4G' : (tags['communication:5GNR'] === 'yes' ? '5G' : 'Unknown');
                tLat = el.lat;
                tLng = el.lon;
                infoHtml = `<div><b>Ref:</b> ${tags.ref || el.id}</div>
                          <div><b>Type:</b> ${tags['tower:type'] || 'Tower'}</div>
                          <div><b>Height:</b> ${tags.height || '?'}m</div>`;
              }

              if (!foundOps.has(opRaw)) foundOps.set(opRaw, color);

              const marker = L.marker([tLat, tLng], {
                icon: L.divIcon({
                  className: '',
                  html: `<div class="tower-icon" style="background:${color}22;color:${color};border-color:${color};">üì°</div>`,
                  iconSize: [28, 28], iconAnchor: [14, 14]
                })
              }).addTo(window.networkMap)
                .bindPopup(`<div style="font-family:'Rajdhani',sans-serif;min-width:175px;">
                <b style="color:${color};font-size:1rem;">üì° ${opRaw}</b>
                <hr style="border-color:${color}55;margin:6px 0;">
                ${infoHtml}
              </div>`);
              window.localHubs.push(marker);
            });

            if (legend) {
              if (foundOps.size === 0) {
                legend.innerHTML = `<h4>üì° Networks</h4><div style="color:#888;font-size:0.72rem;">No tower data found in this area.</div>`;
              } else {
                let rows = '';
                foundOps.forEach((c, name) => rows += `<div class="legend-row"><div class="legend-dot" style="background:${c};"></div>${name}</div>`);
                legend.innerHTML = `<h4>üì° Networks</h4>${rows}<div style="margin-top:8px;color:#888;font-size:0.7rem;">üì∂ Click tower for details</div>`;
              }
            }
          })
          .catch(err => {
            console.error("Tower fetch failed:", err);
            if (legend && legend.innerHTML.includes("Scanning")) {
              legend.innerHTML = `<h4>üì° Networks</h4><div style="color:#f44;font-size:0.72rem;">‚ö† Network servers busy. Retrying...</div>`;
              setTimeout(() => { if (legend.innerHTML.includes("busy")) fetchTowers(overpassServers[0], false); }, 5000);
            }
          });
      };

      // Try local proxy (OpenCelliD) first, fallback to Overpass (OSM) for static sites
      fetch(`http://127.0.0.1:5002/api/towers?lat=${lat}&lng=${lng}`)
        .then(r => {
          if (!r.ok) throw new Error('Proxy unavailable');
          return fetchTowers(`http://127.0.0.1:5002/api/towers?lat=${lat}&lng=${lng}`, true);
        })
        .catch(() => {
          console.log("Static Mode: Using Overpass API cluster");
          return fetchTowers(overpassServers[0], false);
        });

      if (window.updateMapTraffic) window.updateMapTraffic();
    }

    // Initialize map on load if needed
    window.addEventListener('load', () => {
      // initNetworkMap(); // deferred until tab is clicked
    });
  </script>
</body>

</html>